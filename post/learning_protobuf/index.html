<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Google,入门,教程,实例,Protocol Buffers,protobuf," />





  <link rel="alternate" href="/atom.xml" title="GinoBeFunny" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta name="description" content="随着微服务架构的流行，RPC框架渐渐地成为服务框架的一个重要部分。在很多RPC的设计中，都采用了高性能的编解码技术，Protocol Buffers就属于其中的佼佼者。Protocol Buffers是Google开源的一个语言无关、平台无关的通信协议，其小巧、高效和友好的兼容性设计，使其被广泛使用。">
<meta property="og:type" content="article">
<meta property="og:title" content="Protocol Buffers简明教程">
<meta property="og:url" content="http://ginobefunny.com/post/learning_protobuf/index.html">
<meta property="og:site_name" content="GinoBeFunny">
<meta property="og:description" content="随着微服务架构的流行，RPC框架渐渐地成为服务框架的一个重要部分。在很多RPC的设计中，都采用了高性能的编解码技术，Protocol Buffers就属于其中的佼佼者。Protocol Buffers是Google开源的一个语言无关、平台无关的通信协议，其小巧、高效和友好的兼容性设计，使其被广泛使用。">
<meta property="og:image" content="http://oi46mo3on.bkt.clouddn.com/13_learning_protobuf/protobuf_comparation_time.png">
<meta property="og:image" content="http://oi46mo3on.bkt.clouddn.com/13_learning_protobuf/protobuf_comparation_bytes.png">
<meta property="og:image" content="http://oi46mo3on.bkt.clouddn.com/13_learning_protobuf/protobuf_comparation_result.png">
<meta property="og:image" content="http://oi46mo3on.bkt.clouddn.com/13_learning_protobuf/AddPerson1.png">
<meta property="og:image" content="http://oi46mo3on.bkt.clouddn.com/13_learning_protobuf/AddPerson2.png">
<meta property="og:image" content="http://oi46mo3on.bkt.clouddn.com/13_learning_protobuf/ListPerson.png">
<meta property="og:updated_time" content="2017-02-10T05:12:25.760Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Protocol Buffers简明教程">
<meta name="twitter:description" content="随着微服务架构的流行，RPC框架渐渐地成为服务框架的一个重要部分。在很多RPC的设计中，都采用了高性能的编解码技术，Protocol Buffers就属于其中的佼佼者。Protocol Buffers是Google开源的一个语言无关、平台无关的通信协议，其小巧、高效和友好的兼容性设计，使其被广泛使用。">
<meta name="twitter:image" content="http://oi46mo3on.bkt.clouddn.com/13_learning_protobuf/protobuf_comparation_time.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://ginobefunny.com/post/learning_protobuf/"/>





  <title> Protocol Buffers简明教程 | GinoBeFunny </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-86468813-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ae24983a3465fec4833d9e0c2b125a35";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">GinoBeFunny</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Be a creator of knowledge.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-my2017">
          <a href="/my2017" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-trophy"></i> <br />
            
            My 2017
          </a>
        </li>
      
        
        <li class="menu-item menu-item-joy_of_reading">
          <a href="/joy_of_reading" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-asterisk"></i> <br />
            
            趣读书
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://ginobefunny.com/post/learning_protobuf/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Gino Zhang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="GinoBeFunny">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="GinoBeFunny" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Protocol Buffers简明教程
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-07T19:32:47+08:00">
                2017-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenSource/" itemprop="url" rel="index">
                    <span itemprop="name">OpenSource</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 阅读次数
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>随着微服务架构的流行，RPC框架渐渐地成为服务框架的一个重要部分。在很多RPC的设计中，都采用了高性能的编解码技术，Protocol Buffers就属于其中的佼佼者。<a href="https://github.com/google/protobuf" target="_blank" rel="external">Protocol Buffers</a>是Google开源的一个语言无关、平台无关的通信协议，其小巧、高效和友好的兼容性设计，使其被广泛使用。<br><a id="more"></a></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="protobuf是什么？"><a href="#protobuf是什么？" class="headerlink" title="protobuf是什么？"></a>protobuf是什么？</h3><blockquote>
<p>Protocol buffers are Google’s language-neutral, platform-neutral, extensible mechanism for serializing structured data – think XML, but smaller, faster, and simpler. You define how you want your data to be structured once, then you can use special generated source code to easily write and read your structured data to and from a variety of data streams and using a variety of languages.</p>
</blockquote>
<ul>
<li>Google良心企业出厂的；</li>
<li>是一种序列化对象框架（或者说是编解码框架），其他功能相似的有Java自带的序列化、Facebook的Thrift和JBoss Marshalling等；</li>
<li>通过proto文件定义结构化数据，其他功能相似的比如XML、JSON等；</li>
<li>自带代码生成器，支持多种语言；</li>
</ul>
<h3 id="为什么叫“Protocol-Buffers”？"><a href="#为什么叫“Protocol-Buffers”？" class="headerlink" title="为什么叫“Protocol Buffers”？"></a>为什么叫“Protocol Buffers”？</h3><p>官方如是说：</p>
<blockquote>
<p>The name originates from the early days of the format, before we had the protocol buffer compiler to generate classes for us. At the time, there was a class called ProtocolBuffer which actually acted as a buffer for an individual method. Users would add tag/value pairs to this buffer individually by calling methods like AddValue(tag, value). The raw bytes were stored in a buffer which could then be written out once the message had been constructed.</p>
<p>Since that time, the “buffers” part of the name has lost its meaning, but it is still the name we use. Today, people usually use the term “protocol message” to refer to a message in an abstract sense, “protocol buffer” to refer to a serialized copy of a message, and “protocol message object” to refer to an in-memory object representing the parsed message.</p>
</blockquote>
<h3 id="核心特点"><a href="#核心特点" class="headerlink" title="核心特点"></a>核心特点</h3><ul>
<li>语言无关、平台无关</li>
<li>简洁</li>
<li>高性能</li>
<li>良好的兼容性</li>
</ul>
<h3 id="“变态的”性能表现"><a href="#“变态的”性能表现" class="headerlink" title="“变态的”性能表现"></a>“变态的”性能表现</h3><p>有位网友曾经做过<a href="http://agapple.iteye.com/blog/859052" target="_blank" rel="external">各种通用序列化协议技术的对比</a>，我这里直接拿来给大家感受一下：</p>
<p><strong>序列化响应时间对比</strong></p>
<p><img src="http://oi46mo3on.bkt.clouddn.com/13_learning_protobuf/protobuf_comparation_time.png" alt="序列化响应时间对比"></p>
<p><strong>序列化bytes对比</strong></p>
<p><img src="http://oi46mo3on.bkt.clouddn.com/13_learning_protobuf/protobuf_comparation_bytes.png" alt="序列化bytes对比"></p>
<p><strong>具体的数字</strong></p>
<p><img src="http://oi46mo3on.bkt.clouddn.com/13_learning_protobuf/protobuf_comparation_result.png" alt="具体的数字"></p>
<h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><p>以下示例源码已上传至github：<a href="https://github.com/ginobefun/learning_projects/tree/master/learning-protobuf" target="_blank" rel="external">https://github.com/ginobefun/learning_projects/tree/master/learning-protobuf</a></p>
<h3 id="新建一个maven项目并添加依赖"><a href="#新建一个maven项目并添加依赖" class="headerlink" title="新建一个maven项目并添加依赖"></a>新建一个maven项目并添加依赖</h3><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;com.ginobefunny.learning&lt;/groupId&gt;
    &lt;artifactId&gt;leanring-protobuf&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.google.protobuf&lt;/groupId&gt;
            &lt;artifactId&gt;protobuf-java&lt;/artifactId&gt;
            &lt;version&gt;3.2.0&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre><h3 id="新建protobuf的消息定义文件addressbook-proto"><a href="#新建protobuf的消息定义文件addressbook-proto" class="headerlink" title="新建protobuf的消息定义文件addressbook.proto"></a>新建protobuf的消息定义文件addressbook.proto</h3><pre><code>syntax = &quot;proto3&quot;; // 声明为protobuf 3定义文件
package tutorial;

option java_package = &quot;com.ginobefunny.learning.protobuf.message&quot;; // 声明生成消息类的java包路径
option java_outer_classname = &quot;AddressBookProtos&quot;;  // 声明生成消息类的类名

message Person {
  string name = 1;
  int32 id = 2;
  string email = 3;

  enum PhoneType {
    MOBILE = 0;
    HOME = 1;
    WORK = 2;
  }

  message PhoneNumber {
    string number = 1;
    PhoneType type = 2;
  }

  repeated PhoneNumber phones = 4;
}

message AddressBook {
  repeated Person people = 1;
}
</code></pre><h3 id="使用protoc工具生成消息对应的Java类"><a href="#使用protoc工具生成消息对应的Java类" class="headerlink" title="使用protoc工具生成消息对应的Java类"></a>使用protoc工具生成消息对应的Java类</h3><ul>
<li>从<a href="https://github.com/google/protobuf/releases/" target="_blank" rel="external">已发布版本</a>中下载protoc工具，比如protoc-3.2.0-win32；</li>
<li>解压后将bin目录添加到path路径；</li>
<li>执行以下protoc命令生成Java类：</li>
</ul>
<pre><code>protoc -I=. --java_out=src/main/java addressbook.proto
</code></pre><h3 id="编写测试类写入和读取序列化文件"><a href="#编写测试类写入和读取序列化文件" class="headerlink" title="编写测试类写入和读取序列化文件"></a>编写测试类写入和读取序列化文件</h3><ul>
<li>AddPerson类通过用户每次添加一个联系人，并序列化保存到指定文件中。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddPerson</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 通过用户输入构建一个Person对象</span></div><div class="line">    <span class="keyword">static</span> AddressBookProtos.<span class="function">Person <span class="title">promptForAddress</span><span class="params">(BufferedReader stdin,</span></span></div><div class="line">                                                     PrintStream stdout) <span class="keyword">throws</span> IOException &#123;</div><div class="line">        AddressBookProtos.Person.Builder person = AddressBookProtos.Person.newBuilder();</div><div class="line"></div><div class="line">        stdout.print(<span class="string">"Enter person ID: "</span>);</div><div class="line">        person.setId(Integer.valueOf(stdin.readLine()));</div><div class="line"></div><div class="line">        stdout.print(<span class="string">"Enter name: "</span>);</div><div class="line">        person.setName(stdin.readLine());</div><div class="line"></div><div class="line">        stdout.print(<span class="string">"Enter email address (blank for none): "</span>);</div><div class="line">        String email = stdin.readLine();</div><div class="line">        <span class="keyword">if</span> (email.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">            person.setEmail(email);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            stdout.print(<span class="string">"Enter a phone number (or leave blank to finish): "</span>);</div><div class="line">            String number = stdin.readLine();</div><div class="line">            <span class="keyword">if</span> (number.length() == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            AddressBookProtos.Person.PhoneNumber.Builder phoneNumber =</div><div class="line">                    AddressBookProtos.Person.PhoneNumber.newBuilder().setNumber(number);</div><div class="line"></div><div class="line">            stdout.print(<span class="string">"Is this a mobile, home, or work phone? "</span>);</div><div class="line">            String type = stdin.readLine();</div><div class="line">            <span class="keyword">if</span> (type.equals(<span class="string">"mobile"</span>)) &#123;</div><div class="line">                phoneNumber.setType(AddressBookProtos.Person.PhoneType.MOBILE);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.equals(<span class="string">"home"</span>)) &#123;</div><div class="line">                phoneNumber.setType(AddressBookProtos.Person.PhoneType.HOME);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.equals(<span class="string">"work"</span>)) &#123;</div><div class="line">                phoneNumber.setType(AddressBookProtos.Person.PhoneType.WORK);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                stdout.println(<span class="string">"Unknown phone type.  Using default."</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            person.addPhones(phoneNumber);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> person.build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 加载指定的序列化文件（如不存在则创建一个新的），再通过用户输入增加一个新的联系人到地址簿，最后序列化到文件中</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">if</span> (args.length != <span class="number">1</span>) &#123;</div><div class="line">            System.err.println(<span class="string">"Usage:  AddPerson ADDRESS_BOOK_FILE"</span>);</div><div class="line">            System.exit(-<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        AddressBookProtos.AddressBook.Builder addressBook = AddressBookProtos.AddressBook.newBuilder();</div><div class="line"></div><div class="line">        <span class="comment">// Read the existing address book.</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            addressBook.mergeFrom(<span class="keyword">new</span> FileInputStream(args[<span class="number">0</span>]));</div><div class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</div><div class="line">            System.out.println(args[<span class="number">0</span>] + <span class="string">": File not found.  Creating a new file."</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Add an address.</span></div><div class="line">        addressBook.addPeople(promptForAddress(<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in)),</div><div class="line">                        System.out));</div><div class="line"></div><div class="line">        <span class="comment">// Write the new address book back to disk.</span></div><div class="line">        FileOutputStream output = <span class="keyword">new</span> FileOutputStream(args[<span class="number">0</span>]);</div><div class="line">        addressBook.build().writeTo(output);</div><div class="line">        output.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ListPeople类读取序列化文件并输出所有联系人信息。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListPeople</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 打印地址簿中所有联系人信息</span></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(AddressBookProtos.AddressBook addressBook)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (AddressBookProtos.Person person: addressBook.getPeopleList()) &#123;</div><div class="line">            System.out.println(<span class="string">"Person ID: "</span> + person.getId());</div><div class="line">            System.out.println(<span class="string">"  Name: "</span> + person.getName());</div><div class="line">            <span class="keyword">if</span> (!person.getPhonesList().isEmpty()) &#123;</div><div class="line">                System.out.println(<span class="string">"  E-mail address: "</span> + person.getEmail());</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (AddressBookProtos.Person.PhoneNumber phoneNumber : person.getPhonesList()) &#123;</div><div class="line">                <span class="keyword">switch</span> (phoneNumber.getType()) &#123;</div><div class="line">                    <span class="keyword">case</span> MOBILE:</div><div class="line">                        System.out.print(<span class="string">"  Mobile phone #: "</span>);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> HOME:</div><div class="line">                        System.out.print(<span class="string">"  Home phone #: "</span>);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> WORK:</div><div class="line">                        System.out.print(<span class="string">"  Work phone #: "</span>);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                System.out.println(phoneNumber.getNumber());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 加载指定的序列化文件，并输出所有联系人信息</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">if</span> (args.length != <span class="number">1</span>) &#123;</div><div class="line">            System.err.println(<span class="string">"Usage:  ListPeople ADDRESS_BOOK_FILE"</span>);</div><div class="line">            System.exit(-<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Read the existing address book.</span></div><div class="line">        AddressBookProtos.AddressBook addressBook =</div><div class="line">                AddressBookProtos.AddressBook.parseFrom(<span class="keyword">new</span> FileInputStream(args[<span class="number">0</span>]));</div><div class="line"></div><div class="line">        print(addressBook);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="验证效果"><a href="#验证效果" class="headerlink" title="验证效果"></a>验证效果</h3><p>先添加一个联系人Gino</p>
<p><img src="http://oi46mo3on.bkt.clouddn.com/13_learning_protobuf/AddPerson1.png" alt="添加一个联系人Gino"></p>
<p>再添加一个联系人Slightly</p>
<p><img src="http://oi46mo3on.bkt.clouddn.com/13_learning_protobuf/AddPerson2.png" alt="添加一个联系人Gino"></p>
<p>最后显示所有联系人信息</p>
<p><img src="http://oi46mo3on.bkt.clouddn.com/13_learning_protobuf/ListPerson.png" alt="添加一个联系人Gino"></p>
<h3 id="实例小结"><a href="#实例小结" class="headerlink" title="实例小结"></a>实例小结</h3><ul>
<li>通过以上的例子我们能大概感受到开发protobuf序列化的大致步骤：定义proto文件、生成对应的Java类文件、通过消息类的构造器构造对象并通过writeTo序列化、通过parseFrom反序列化对象；</li>
<li>如果查看中间序列化的文件，我们可以发现protobuf序列化的二进制文件非常紧凑，因此文件更小，传输性能更好。</li>
</ul>
<h2 id="深入学习"><a href="#深入学习" class="headerlink" title="深入学习"></a>深入学习</h2><h3 id="关于proto文件"><a href="#关于proto文件" class="headerlink" title="关于proto文件"></a>关于proto文件</h3><h4 id="protobuf版本"><a href="#protobuf版本" class="headerlink" title="protobuf版本"></a>protobuf版本</h4><ul>
<li>protobuf现在主流的有2.X和3.X版本，两者之间相差比较大，对于刚采用的建议使用3.X版本；</li>
<li>如果采用3.X版本，需要再proto文件第一个非注释行声明（就像我们上面的例子那样），因为protobuf默认认为是2.X版本；</li>
</ul>
<h4 id="message结构"><a href="#message结构" class="headerlink" title="message结构"></a>message结构</h4><ul>
<li>在一个proto文件中可以包含多个message定义，message之间可以互相引用，message还可以嵌套message和枚举类；</li>
<li>一个message通常包含一至多个字段；</li>
<li>每个字段包含以下几个部分：字段描述符（可选）、字段类型、字段名称和字段对应的Tag；</li>
</ul>
<h4 id="字段描述符"><a href="#字段描述符" class="headerlink" title="字段描述符"></a>字段描述符</h4><p>字段描述符用于描述字段出现的频率，有以下两个可选值：</p>
<ul>
<li>singular：表示出现0次或1次；如果没有声明描述符，默认为singular；</li>
<li>repeated：表示出现0次或多次；</li>
</ul>
<h4 id="字段类型"><a href="#字段类型" class="headerlink" title="字段类型"></a>字段类型</h4><ul>
<li>基本数据类型：包括double、float、bool、string、bytes、int32、int64、uint32、uint64、sint32、sint64、fixed32、fixed64、sfixed32、sfixed64；</li>
<li>引用其他message类型：这个就有点像我们Java里面的对象引用的方式；</li>
<li>枚举类型：对于枚举类型，protobuf有个约束：枚举的第一项对应的值必须为0；下面是一个包含枚举类型的消息定义：</li>
</ul>
<pre><code>message SearchRequest {
  string query = 1;
  int32 page_number = 2;
  int32 result_per_page = 3;
  enum Corpus {
    UNIVERSAL = 0;
    WEB = 1;
    IMAGES = 2;
    LOCAL = 3;
    NEWS = 4;
    PRODUCTS = 5;
    VIDEO = 6;
  }
  Corpus corpus = 4;
}
</code></pre><h4 id="字段对应的Tag"><a href="#字段对应的Tag" class="headerlink" title="字段对应的Tag"></a>字段对应的Tag</h4><ul>
<li>对应同一个message里面的字段，每个字段的Tag是必须唯一数字；</li>
<li>Tag主要用于说明字段在二进制文件的对应关系，一旦指定字段为对应的Tag，不应该在后续进行变更；</li>
<li>对于Tag的分配，1~15只用一个byte进行编码（因此应该留给那些常用的字段），16~2047用两个byte进行编码，最大支持到536870911，但是中间有一段（19000~19999）是protobuf内部使用的；</li>
<li>可以通过reserved关键字来预留Tag和字段名，还有一种场景是如果某个字段已经被废弃了不希望后续被采用，也可以用reserved关键字声明；</li>
</ul>
<h4 id="字段的默认值"><a href="#字段的默认值" class="headerlink" title="字段的默认值"></a>字段的默认值</h4><p>protobuf 2.X版本是支持在字段中声明默认值的，但是在3.X版本中去掉了默认值的定义，主要是为了区别用户是否设置了一个和默认值一样的值的情况。对于3.X版本，protobuf采用以下规则处理默认值：</p>
<ul>
<li>对应string类型，默认值为一个空字符串；</li>
<li>对于bytes类型，默认值为一个空的byte数组；</li>
<li>对于bool类型，默认值为false；</li>
<li>对于数值类型，默认值为0；</li>
<li>对于枚举类型，默认值为第一项，也即值为0的那个枚举值；</li>
<li>对于引用其他message类型：其默认值和对应的语言是相关的；</li>
</ul>
<h3 id="Map字段类型"><a href="#Map字段类型" class="headerlink" title="Map字段类型"></a>Map字段类型</h3><ul>
<li>protobuf也支持定义Map类型的字段，但是对于Map的key的类型只能是整数型（包括各种int32和int64）和string类型；</li>
<li>Map类型不能定义为repeated；</li>
<li>Map类型的数据是无序的；</li>
<li>以下是一个Map类型的字段定义示例：</li>
</ul>
<pre><code>map&lt;string, Project&gt; projects = 3;
</code></pre><h3 id="导入其他proto文件"><a href="#导入其他proto文件" class="headerlink" title="导入其他proto文件"></a>导入其他proto文件</h3><ul>
<li>可以通过import关键字导入其他proto文件，从而重用message类型；下面是一个import的示例：</li>
</ul>
<pre><code>import &quot;myproject/other_protos.proto&quot;;
</code></pre><h3 id="如果proto中的message要扩展怎么办？"><a href="#如果proto中的message要扩展怎么办？" class="headerlink" title="如果proto中的message要扩展怎么办？"></a>如果proto中的message要扩展怎么办？</h3><p>proto具有很好的扩展性，但是也要遵循以下原则：</p>
<ul>
<li>不能修改原有字段的Tag；</li>
<li>如果新增一个字段，对于老的二进制序列化文件处理时会给这个字段增加默认值；如果是升级了proto文件而没有升级对应的代码，则新的字段会被忽略；</li>
<li>可以删除字段，但是对应的Tag不应该再被使用，否则对于之前的二进制序列化消息处理时对应关系出现问题；</li>
<li>int32、uint32、int64、uint64和bool类型是相互兼容的，这意味着你可以在他们之间修改类型而不会有兼容性问题；</li>
</ul>
<h3 id="Any消息类型"><a href="#Any消息类型" class="headerlink" title="Any消息类型"></a>Any消息类型</h3><ul>
<li>protobuf内置了一些通用的消息类型，Any就是其他的一种，通过查看它的proto文件可以看到它包含了一个URL标识符和一个byte数组；</li>
<li>在使用Any消息类型之前，需要通过<strong>import “google/protobuf/any.proto”;</strong>导入proto文件定义；</li>
</ul>
<h3 id="Oneof关键字"><a href="#Oneof关键字" class="headerlink" title="Oneof关键字"></a>Oneof关键字</h3><ul>
<li>oneof关键字用于声明一组字段中，必须要有一个字段被赋值；通常比如我们在登陆的时候，可以用手机号、邮箱和用户名登陆，这种时候就可以使用oneof来定义；</li>
<li>当我们对oneof其中一个字段赋值时，其他字段的值将会被清空；所以只有最后一次赋值是有效的；</li>
<li>下面是一个oneof的示例：</li>
</ul>
<pre><code>message LoginMessage {
  oneof user_identifier {
    string user_name = 4;
    string phone_num = 5;
    string user_email = 6;
  }

  string password = 10;
}
</code></pre><h3 id="定义服务"><a href="#定义服务" class="headerlink" title="定义服务"></a>定义服务</h3><ul>
<li>在proto文件中还允许定义RPC服务，以下是一个示例：</li>
</ul>
<pre><code>service SearchService {
  rpc Search (SearchRequest) returns (SearchResponse);
}
</code></pre><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li>随着微服务架构的流行，RPC框架渐渐地成为服务框架的一个重要部分。在很多RPC的设计中，都采用了高性能的编解码技术，protobuf就属于其中的佼佼者；</li>
<li>protobuf相对于其他编解码框架，有着非常惊人的性能表现；</li>
<li>通过一个简单的实例，我们了解如果使用protobuf进行序列化和数据交互；</li>
<li>最后，我们列举了一些重要的特性和配置说明，这些在我们使用protobuf中都会给频繁使用；</li>
<li>后续学习：后面我会根据所学的Netty和protobuf知识，开发一个简单的RPC框架。</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://developers.google.com/protocol-buffers/docs/proto3" target="_blank" rel="external">Language Guide (proto3)</a></li>
<li><a href="https://developers.google.com/protocol-buffers/docs/javatutorial" target="_blank" rel="external">Protocol Buffer Basics: Java</a></li>
<li><a href="https://developers.google.com/protocol-buffers/docs/reference/java-generated" target="_blank" rel="external">Java Generated Code</a></li>
<li><a href="https://solicomo.com/network-dev/protobuf-proto3-vs-proto2.html" target="_blank" rel="external">Protobuf 的 proto3 与 proto2 的区别</a></li>
<li><a href="http://agapple.iteye.com/blog/859052" target="_blank" rel="external">几种序列化协议(protobuf,xstream,jackjson,jdk,hessian)相关数据对比</a></li>
</ul>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/images/wechat.jpg" alt="Gino Zhang wechat" style="width: 200px; max-width: 100%;"/>
    <div>扫一扫，关注我的微信公众号</div>
</div>


      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Google/" rel="tag"># Google</a>
          
            <a href="/tags/入门/" rel="tag"># 入门</a>
          
            <a href="/tags/教程/" rel="tag"># 教程</a>
          
            <a href="/tags/实例/" rel="tag"># 实例</a>
          
            <a href="/tags/Protocol-Buffers/" rel="tag"># Protocol Buffers</a>
          
            <a href="/tags/protobuf/" rel="tag"># protobuf</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/post/soft_skills/" rel="next" title="代码之外的生存指南">
                <i class="fa fa-chevron-left"></i> 代码之外的生存指南
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/post/reading_record_201702/" rel="prev" title="阅读随手记 201702">
                阅读随手记 201702 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Gino Zhang" />
          <p class="site-author-name" itemprop="name">Gino Zhang</p>
          <p class="site-description motion-element" itemprop="description">Just be funny!</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">39</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">133</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ginobefun/" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/5202141318/profile?topnav=1&wvr=6&is_all=1" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/ginobefun/" target="_blank" title="DouBan">
                  
                    <i class="fa fa-fw fa-book"></i>
                  
                  DouBan
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/ginobefun/activities" target="_blank" title="ZhiHu">
                  
                    <i class="fa fa-fw fa-ticket"></i>
                  
                  ZhiHu
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/ginobefun" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/0ffaa3601861" target="_blank" title="JianShu">
                  
                    <i class="fa fa-fw fa-gift"></i>
                  
                  JianShu
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://wangnan.tech/" title="王楠的博客" target="_blank">王楠的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://toutiao.io/subjects/160373" title="开发者头条" target="_blank">开发者头条</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.yohobuy.com/" title="Yoho!Buy" target="_blank">Yoho!Buy</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://theme-next.iissnan.com/" title="Hexo Next Theme" target="_blank">Hexo Next Theme</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#protobuf是什么？"><span class="nav-number">1.1.</span> <span class="nav-text">protobuf是什么？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么叫“Protocol-Buffers”？"><span class="nav-number">1.2.</span> <span class="nav-text">为什么叫“Protocol Buffers”？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#核心特点"><span class="nav-number">1.3.</span> <span class="nav-text">核心特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#“变态的”性能表现"><span class="nav-number">1.4.</span> <span class="nav-text">“变态的”性能表现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速开始"><span class="nav-number">2.</span> <span class="nav-text">快速开始</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#新建一个maven项目并添加依赖"><span class="nav-number">2.1.</span> <span class="nav-text">新建一个maven项目并添加依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建protobuf的消息定义文件addressbook-proto"><span class="nav-number">2.2.</span> <span class="nav-text">新建protobuf的消息定义文件addressbook.proto</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用protoc工具生成消息对应的Java类"><span class="nav-number">2.3.</span> <span class="nav-text">使用protoc工具生成消息对应的Java类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写测试类写入和读取序列化文件"><span class="nav-number">2.4.</span> <span class="nav-text">编写测试类写入和读取序列化文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证效果"><span class="nav-number">2.5.</span> <span class="nav-text">验证效果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实例小结"><span class="nav-number">2.6.</span> <span class="nav-text">实例小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#深入学习"><span class="nav-number">3.</span> <span class="nav-text">深入学习</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关于proto文件"><span class="nav-number">3.1.</span> <span class="nav-text">关于proto文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#protobuf版本"><span class="nav-number">3.1.1.</span> <span class="nav-text">protobuf版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#message结构"><span class="nav-number">3.1.2.</span> <span class="nav-text">message结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#字段描述符"><span class="nav-number">3.1.3.</span> <span class="nav-text">字段描述符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#字段类型"><span class="nav-number">3.1.4.</span> <span class="nav-text">字段类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#字段对应的Tag"><span class="nav-number">3.1.5.</span> <span class="nav-text">字段对应的Tag</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#字段的默认值"><span class="nav-number">3.1.6.</span> <span class="nav-text">字段的默认值</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Map字段类型"><span class="nav-number">3.2.</span> <span class="nav-text">Map字段类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#导入其他proto文件"><span class="nav-number">3.3.</span> <span class="nav-text">导入其他proto文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如果proto中的message要扩展怎么办？"><span class="nav-number">3.4.</span> <span class="nav-text">如果proto中的message要扩展怎么办？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Any消息类型"><span class="nav-number">3.5.</span> <span class="nav-text">Any消息类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Oneof关键字"><span class="nav-number">3.6.</span> <span class="nav-text">Oneof关键字</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定义服务"><span class="nav-number">3.7.</span> <span class="nav-text">定义服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">4.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">5.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Gino Zhang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i> 访问人数<span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i> 总访问量<span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
